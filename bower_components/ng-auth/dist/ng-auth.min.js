/*! ng-auth 20-01-2016 v1.1.4 */
!function(a,b){"use strict";function c(b,c){return c.localStorage[n+"-"+l.client_id+"-code"]=a.toJson(b),b}function d(b,d){var e=Date.now();return b.refresh_token&&c({code:b.refresh_token},d),b.expires_at=b.expires_at||e+1e3*b.expires_in-m,d.sessionStorage[n+"-"+l.client_id+"-token"]=a.toJson(b),b}function e(b,c,d){var e=a.copy(b),f=e.token_url;return f+="?client_id="+e.client_id,f+="&code="+c.code,f+="&grant_type=authorization_code",f+="&redirect_uri="+(e.redirect_uri===!0?d.absUrl().split("#")[0].split("?")[0]:e.redirect_uri)}function f(b,c,d){var e=a.copy(b),f=e.oauth2_url+"?",g=c.url(),h=c.absUrl().split("#")[0].split("?")[0];return c.$$html5&&(d.localStorage.authPath=c.$$path,h=c.protocol()+"://"+c.host(),-1!==h.indexOf("localhost")&&(h+=":"+c.port()),h+="/"),f+="client_id="+e.client_id,f=e.scope.length?f+"&scope="+e.scope.join(" ").replace(/\s/g,"%20"):f,f=e.state===!0?f+"&state="+encodeURIComponent(g):a.isString(e.state)?f+"&state="+encodeURIComponent(e.state):f,f+="&response_type="+(e.response_type||l.response_type),f=e.redirect_uri===!0?f+"&redirect_uri="+h:f+"&redirect_uri="+e.redirect_uri,a.forEach(e.options,function(a,b){f+="&"+b+"="+a}),f}function g(a,c){var d,e={},f="",g=a.split(c||"#");if(g.length>1)for("/"===g[1].charAt(0)&&(g[1]=g[1].substring(1)),f=g[1];d=o.exec(f);)e[decodeURIComponent(d[1])]=decodeURIComponent(d[2]);return e.hash=g[2],e.hash===b&&delete e.hash,e}function h(b,c){var d=!1;return a.forEach(c.content_urls,function(a){0===b.indexOf(a)&&(d=!0)}),d}function i(b){l.state=b.state||l.state,l.redirect_uri=b.redirectUri||l.redirect_uri,l.response_type=b.responseType||l.response_type,l.path_delimiter=b.pathDelimiter||l.path_delimiter,a.isArray(b.contentUrls)&&a.forEach(b.contentUrls,function(a){-1===l.content_urls.indexOf(a)&&l.content_urls.push(a)}),l.popup=b.popup||l.popup,a.isArray(b.scope)&&a.forEach(b.scope,function(a){-1===l.scope.indexOf(a)&&l.scope.push(a)}),l.oauth2_url=b.oauth2Url||l.oauth2_url,l.token_url=b.tokenUrl,l.client_id=b.clientId||l.client_id,l.client_secret=b.clientSecret,l.options=a.extend({},l.options,b.options||{}),l.auto_auth=null==b.autoAuth?l.auto_auth:b.autoAuth}function j(b,h,j,k){function m(){function b(){a.element(k.document).find("body").removeAttr("oauth-hide")}if(!l.client_id||!l.redirect_uri||!l.oauth2_url)throw new Error("Missing required configuration options");var e=g(k.location.href,l.path_delimiter);{if(!e.access_token||!e.expires_in)return e.code?(c(e,k),void p.getTokenFromCode(e).then(function(a){o=!0,d(a,k),b(),j.search("");var c=k.localStorage.authPath;c&&(j.path(c),delete k.localStorage.authPath)})):!p.isAuthenticated()&&a.isObject(p.getToken())?void p.authenticate():p.isAuthenticated()?void b():void(l.auto_auth&&p.authenticate());if(o=!0,d(e,k),b(),e.state){var f=e.state.split("?");j.path(f[0]),j.search(g(f.slice(1).length?"#"+f.slice(1)[0]:""));var h=e.hash;h&&"undefined"!==h&&j.hash(h)}else~j.hash().indexOf("/access_token")&&j.hash("")}}var o=!1,p={};return p.registerCallback=function(a){return!o||a()},p.authenticate=function(){var a=f(l,j,k);k.location.href=a,l.redirecting=!0},p.lateConfig=i,p.isAuthenticated=function(){var b=p.getToken(),c=(new Date).getTime(),e=a.isDefined(b)&&parseInt(b.expires_at)>c;return e&&d(b,k),e},p.wasAuthenticated=function(){var a=p.getToken();return a?!0:!1},p.getTokenFromCode=function(b){var c=h.defer();return fetch(e(l,b,j),{method:"get",headers:{Accept:"application/json"}}).then(function(a){return a.json()}).then(function(b){return a.isObject(b)&&!b.error?void c.resolve(d(b,k)):void c.reject("Token was not received as JSON")})["catch"](function(){c.reject("Something bad happened")}),c.promise},p.updateToken=function(){var c=h.defer();return b.get("$http")({url:f(l,j,k),method:"GET",withCredentials:!0,headers:{Accept:"application/json"}}).success(function(b){return a.isObject(b)?void c.resolve(d(b,k)):void c.reject("Token was not received as JSON")}).error(function(){console.warn("Attempted to retrieve token async, fallback to default method"),c.reject("Couldn't get token, re-authenticate"),p.authenticate()}),c.promise},p.getConfig=function(){return a.copy(l)},p.getToken=function(){return a.fromJson(k.sessionStorage[n+"-"+l.client_id+"-token"])},p.getCode=function(){return a.fromJson(k.localStorage[n+"-"+l.client_id+"-code"])},m(),p}function k(a,b){b.defaults.useXDomain=!0,delete b.defaults.headers.common["X-Requested-With"],a.factory("authInterceptor",["$oauth2","$q","$window","$timeout",function(a,b,c,e){function f(b,c,d){d>j&&c.reject(b),e(function(){a.isAuthenticated()?c.resolve(b):f(b,c,d*i)},d)}function g(a){var c=b.defer();return f(a,c,10),c.promise}var i=2,j=2e3;return{request:function(e){return h(e.url,l)?a.isAuthenticated()?(e.headers.Authorization="Bearer "+a.getToken().access_token,e):a.isAuthenticated()||!a.wasAuthenticated()||l.redirecting?g(e):(l.response_type&&"code"===l.response_type?a.getTokenFromCode(a.getCode()):a.updateToken()).then(function(a){return e.headers.Authorization="Bearer "+a.access_token,d(a,c),b.when(e)},function(){return b.reject("Invalid token cant be used for request")}):e}}}]),b.interceptors.push("authInterceptor")}a.module("ng-auth",[]);var l={redirecting:!1,content_urls:[],popup:!1,scope:[],options:{},auto_auth:!0,response_type:"token",path_delimiter:"#"},m=3e5,n="ng-auth",o=/([^&=]+)=([^&]*)/g;k.prototype.$get=["$injector","$q","$location","$window",j],k.prototype.configure=i,a.module("ng-auth").provider("$oauth2",["$provide","$httpProvider",k]),a.module("ng-auth").constant("oauth2-key",n)}(angular);